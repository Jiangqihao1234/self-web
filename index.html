<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>生态学论文结果图谱库</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&family=Noto+Serif+SC:wght@600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
  <style>
    :root{--bg:#f5f7f4;--card:#fff;--line:#d4ded7;--text:#133328;--muted:#607368;--pri:#0f4f3b;--soft:#e9f3ee;--danger:#b42318}
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:"Noto Sans SC",sans-serif;background:var(--bg);color:var(--text)}
    .container{width:min(1180px,95%);margin:0 auto}
    .header{position:sticky;top:0;background:#f5f7f4f0;border-bottom:1px solid var(--line);backdrop-filter:blur(6px);z-index:30}
    .header-inner{height:72px;display:flex;align-items:center;justify-content:space-between;gap:10px}
    .brand{display:flex;align-items:center;gap:10px;cursor:pointer}
    .brand i{width:38px;height:38px;border-radius:10px;background:linear-gradient(135deg,#0f5a44,#2f7a5f);color:#fff;display:grid;place-items:center}
    .brand span{font-family:"Noto Serif SC",serif;font-size:22px;font-weight:700}
    .nav{display:flex;gap:6px;flex-wrap:wrap}
    .nav button{background:transparent;border:1px solid transparent;color:var(--muted);padding:8px 14px;border-radius:999px;cursor:pointer}
    .nav button.active,.nav button:hover{background:var(--soft);border-color:var(--line);color:var(--pri)}
    .search{position:relative;width:270px;max-width:42vw}
    .search i{position:absolute;left:11px;top:50%;transform:translateY(-50%);color:#809589}
    .search input{width:100%;padding:10px 12px 10px 34px;border:1px solid var(--line);border-radius:999px}
    .main{padding:26px 0 40px}
    .page{display:none}.page.active{display:block}
    .hero{text-align:center;margin-bottom:22px}
    .hero h1{font-family:"Noto Serif SC",serif;font-size:clamp(28px,4vw,39px);margin-bottom:8px}
    .hero p{color:var(--muted);max-width:820px;margin:0 auto}
    .stats{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin:18px 0}
    .stat{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:16px;text-align:center}
    .stat i{color:var(--pri)}.stat strong{display:block;font-size:30px;color:var(--pri)}.stat span{font-size:13px;color:var(--muted)}
    .quick{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-bottom:18px}
    .btn{border:none;border-radius:999px;padding:10px 16px;font-size:14px;cursor:pointer;display:inline-flex;align-items:center;gap:8px}
    .btn.primary{background:var(--pri);color:#fff}.btn.secondary{background:#fff;border:1px solid var(--line);color:var(--pri)}.btn.danger{background:#fff3f2;border:1px solid #f3d0cc;color:var(--danger)}
    .panel{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:16px;margin-bottom:14px}
    .panel h2{font-size:17px;margin-bottom:10px}
    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{border:1px solid var(--line);border-radius:999px;background:#fff;color:var(--muted);padding:6px 12px;font-size:13px;cursor:pointer}
    .chip.active{background:var(--pri);border-color:var(--pri);color:#fff}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px}
    .card{border:1px solid var(--line);border-radius:12px;overflow:hidden;background:#fff;cursor:pointer}
    .thumb{height:180px;background:#ecf2ee;display:grid;place-items:center;color:#6d8579;overflow:hidden}
    .thumb img{width:100%;height:100%;object-fit:cover}
    .body{padding:11px}.type{display:inline-block;background:var(--soft);color:var(--pri);border-radius:999px;padding:2px 10px;font-size:12px;margin-bottom:7px}
    .body h3{font-size:15px;margin-bottom:6px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
    .body p{font-size:13px;color:var(--muted);min-height:38px}
    .row{display:flex;gap:8px;margin-top:8px}.row .btn{flex:1;justify-content:center;padding:8px 10px;font-size:13px}
    .empty{border:1px dashed var(--line);border-radius:12px;padding:30px 14px;text-align:center;color:var(--muted)}
    .field{margin-bottom:10px}.field label{display:block;font-size:13px;margin-bottom:5px}
    .field input,.field select,.field textarea{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;font-size:14px;font-family:inherit}
    .field textarea{min-height:90px;resize:vertical}
    .dropzone{border:2px dashed #c0d2c9;border-radius:12px;padding:22px;text-align:center;background:#f8fbf9;cursor:pointer}
    .dropzone.dragover{border-color:var(--pri);background:#eef7f2}
    .preview{margin-top:8px;display:none}.preview.active{display:block}.preview img{width:170px;height:130px;object-fit:cover;border:1px solid var(--line);border-radius:8px}
    .docx-list{display:grid;gap:8px;max-height:280px;overflow:auto;margin-top:8px}
    .docx-item{display:grid;grid-template-columns:72px 1fr;gap:8px;border:1px solid var(--line);border-radius:10px;padding:7px}
    .docx-item img{width:72px;height:54px;object-fit:cover;border-radius:6px}
    .ref-item{border:1px solid var(--line);border-radius:10px;padding:10px;margin-bottom:8px}
    .ref-item p{font-size:13px;color:var(--muted)}
    .modal{position:fixed;inset:0;background:#0009;display:none;align-items:center;justify-content:center;padding:18px;z-index:40}
    .modal.active{display:flex}
    .modal-card{width:min(980px,100%);max-height:90vh;overflow:auto;background:#fff;border-radius:12px;padding:14px}
    .modal-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .modal-head button{width:34px;height:34px;border:none;border-radius:50%;background:#eef3f0;cursor:pointer}
    .modal img{width:100%;max-height:420px;object-fit:contain;background:#f3f7f5;border:1px solid var(--line);border-radius:8px}
    .meta{display:grid;gap:7px;margin-top:10px}.meta b{display:inline-block;min-width:68px;color:#355c4e}
    .footer{text-align:center;color:var(--muted);font-size:13px;padding:18px 0 34px}
    .toast{position:fixed;right:16px;bottom:16px;background:#124434;color:#fff;padding:10px 13px;border-radius:10px;opacity:0;transform:translateY(8px);transition:.2s;z-index:50}
    .toast.show{opacity:1;transform:none}.toast.error{background:#b42318}
    .admin-entry{display:flex;flex-direction:column;align-items:flex-end;gap:4px}
    .admin-state{font-size:12px;color:var(--muted)}
    .hint{font-size:12px;color:var(--muted);margin-top:6px}
    .type-add{display:flex;gap:8px;align-items:center}
    .type-add input{flex:1}
    [hidden]{display:none !important}
    @media (max-width:960px){.header-inner{height:auto;padding:10px 0;flex-wrap:wrap}.search{width:100%;max-width:none}.stats{grid-template-columns:repeat(2,1fr)}}
  </style>
</head>
<body>
  <header class="header">
    <div class="container header-inner">
      <div class="brand" data-page="overview"><i class="fa-solid fa-leaf"></i><span>生态学结果图谱库</span></div>
      <nav class="nav">
        <button class="active" data-page="overview">总览</button>
        <button data-page="gallery">图谱库</button>
        <button data-page="upload">上传/更新</button>
        <button data-page="references">文献库</button>
        <button data-page="about">关于</button>
      </nav>
      <div class="search"><i class="fa-solid fa-magnifying-glass"></i><input id="searchInput" placeholder="搜索图题 / 文献 / 关键词"></div>
      <div class="admin-entry">
        <button class="btn secondary" id="adminToggleBtn" type="button"><i class="fa-solid fa-user-shield"></i><span id="adminToggleText">管理员登录</span></button>
        <span class="admin-state" id="adminStateText">访客模式</span>
      </div>
    </div>
  </header>
  <main class="main container">
    <section class="page active" id="page-overview">
      <div class="hero">
        <h1>生态学论文结果图谱库</h1>
        <p>用于收集、筛选、展示和分享论文结果图参考素材，支持上传、下载与备份恢复。</p>
      </div>
      <div class="stats">
        <div class="stat"><i class="fa-solid fa-shapes"></i><strong id="statTypes">0</strong><span>结果图类型</span></div>
        <div class="stat"><i class="fa-solid fa-images"></i><strong id="statFigures">0</strong><span>结果图总数</span></div>
        <div class="stat"><i class="fa-solid fa-book"></i><strong id="statRefs">0</strong><span>文献总数</span></div>
        <div class="stat"><i class="fa-solid fa-clock"></i><strong id="statDate">--</strong><span>最近更新</span></div>
      </div>
      <div class="quick">
        <button class="btn primary" onclick="showPage('gallery')"><i class="fa-solid fa-compass"></i>进入图谱库</button>
        <button class="btn secondary" onclick="showPage('upload')"><i class="fa-solid fa-upload"></i>上传更新</button>
      </div>
      <div class="panel"><h2>结果图类型筛选</h2><div class="chips" id="overviewTypeChips"></div></div>
      <div class="panel"><h2>最近更新</h2><div class="grid" id="recentGrid"></div></div>
    </section>
    <section class="page" id="page-gallery">
      <div class="panel"><h2>图谱库</h2><div class="chips" id="galleryTypeChips"></div></div>
      <div class="panel">
        <div class="actions">
          <button class="btn secondary" onclick="exportJsonData()"><i class="fa-solid fa-file-export"></i>导出 JSON</button>
          <button id="importJsonBtn" class="btn secondary" onclick="document.getElementById('importJsonInput').click()" hidden><i class="fa-solid fa-file-import"></i>导入 JSON</button>
          <button id="clearAllDataBtn" class="btn danger" onclick="clearAllData()" hidden><i class="fa-solid fa-trash"></i>清空所有数据</button>
          <input id="importJsonInput" type="file" accept=".json,application/json" style="display:none">
        </div>
        <div class="grid" id="galleryGrid"></div>
      </div>
    </section>
    <section class="page" id="page-upload">
      <div class="panel">
        <h2>通过 Word 文档导入（.docx）</h2>
        <p style="color:var(--muted);font-size:13px;margin-bottom:8px">格式约定：H1=结果图类型，H2=结果图内容总结，H3=参考文献信息；H3 下图片为结果图，文字为图题。</p>
        <p class="hint">参考文献信息建议使用 GB/T 7714 格式，例如：Hannah K C, Leston L F V, Knight E C, et al. In the twilight zone: patterns in Common Nighthawk (Chordeiles minor) acoustic signals during the breeding season and recommendations for surveys[J]. Avian Conservation and Ecology, 2022, 17(2).</p>
        <div id="docxDropzone" class="dropzone"><p><i class="fa-solid fa-cloud-arrow-up"></i> 点击或拖拽上传 Word 文档</p><p style="font-size:12px;color:var(--muted)">支持 .docx</p></div>
        <input id="docxFileInput" type="file" accept=".docx" style="display:none">
        <div id="docxPreview" class="preview">
          <p style="font-size:14px;color:var(--pri)">解析预览（确认后写入图谱库）</p>
          <div id="docxList" class="docx-list"></div>
          <div class="actions" style="margin-top:8px">
            <button class="btn primary" id="confirmDocxBtn" onclick="confirmImportDocx()"><i class="fa-solid fa-check"></i>确认导入</button>
            <button class="btn secondary" onclick="cancelDocxPreview()"><i class="fa-solid fa-xmark"></i>取消</button>
          </div>
        </div>
      </div>
      <div class="panel">
        <h2>手动上传单张结果图</h2>
        <form id="manualForm">
          <div class="field">
            <label>结果图图片 *</label>
            <div id="imageDropzone" class="dropzone"><p><i class="fa-solid fa-upload"></i> 点击或拖拽上传图片</p><p style="font-size:12px;color:var(--muted)">PNG/JPG/JPEG，建议 ≤ 10MB</p></div>
            <input id="imageFileInput" type="file" accept="image/*" style="display:none">
            <div id="imagePreview" class="preview"></div>
          </div>
          <div class="field"><label>结果图类型（与下方“新增结果图类型”二选一）*</label><select id="manualType"></select></div>
          <div class="field">
            <label>新增结果图类型（可选）</label>
            <div class="type-add">
              <input id="newTypeInput" placeholder="例如：结构方程模型图">
              <button class="btn secondary" id="addTypeBtn" type="button"><i class="fa-solid fa-plus"></i>新增类型</button>
            </div>
          </div>
          <div class="field"><label>图题 *</label><textarea id="manualTitle" required placeholder="输入完整图题"></textarea></div>
          <div class="field"><label>参考文献信息 *</label><input id="manualReference" required placeholder="如：张三等, 2023, Ecology Letters"></div>
          <p class="hint">请尽量按 GB/T 7714 格式填写，系统会自动识别年份和期刊。</p>
          <div class="field"><label>年份</label><input id="manualYear" type="number" min="1900" max="2100" placeholder="如 2023"></div>
          <div class="field"><label>期刊</label><input id="manualJournal" placeholder="如 Ecology Letters"></div>
          <button class="btn primary" type="submit"><i class="fa-solid fa-plus"></i>添加结果图</button>
        </form>
      </div>
    </section>
    <section class="page" id="page-references"><div class="panel"><h2>文献库</h2><div id="referenceList"></div></div></section>
    <section class="page" id="page-about"><div class="panel"><h2>关于</h2><p>用于收集和分享生态学论文结果图素材。当前优先使用 Supabase 云端存储，支持跨设备同步；也支持导出/导入 JSON 备份。</p></div></section>
  </main>
  <div class="modal" id="detailModal">
    <div class="modal-card">
      <div class="modal-head"><h3>结果图详情</h3><button onclick="closeDetailModal()"><i class="fa-solid fa-xmark"></i></button></div>
      <img id="detailImage" alt="结果图">
      <div class="meta">
        <div><b>类型：</b><span id="detailType"></span></div>
        <div><b>图题：</b><span id="detailTitle"></span></div>
        <div><b>文献：</b><span id="detailReference"></span></div>
        <div><b>年份：</b><span id="detailYear"></span></div>
        <div><b>期刊：</b><span id="detailJournal"></span></div>
      </div>
      <div class="actions" style="margin-top:10px">
        <button class="btn secondary" onclick="downloadCurrentFigure()"><i class="fa-solid fa-download"></i>下载图片</button>
        <button class="btn secondary" onclick="copyDetailTitle()"><i class="fa-solid fa-copy"></i>复制图题</button>
        <button id="deleteFigureBtn" class="btn danger" onclick="deleteCurrentFigure()" hidden><i class="fa-solid fa-trash"></i>删除</button>
      </div>
    </div>
  </div>
  <footer class="footer">
    <p>最后更新：<span id="footerDate">--</span></p>
    <p>生态学论文结果图谱库 · 仅用于学习与研究交流</p>
  </footer>
  <div class="toast" id="toast"></div>
  <script>
    const STORAGE_KEY="eco_fig_library_v2";
    const SUPABASE_URL="https://grcbbrdppxjzuquogotd.supabase.co";
    const SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdyY2JicmRwcHhqenVxdW9nb3RkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzNzU0NTAsImV4cCI6MjA4Njk1MTQ1MH0.iG9y3QtSjwlwvrjdJWpkcVSjGIsftw-cpfLJBqm1TQY";
    const SUPABASE_TABLE="eco_figures";
    const SUPABASE_BUCKET="eco-figures";
    const sbClient=(window.supabase&&window.supabase.createClient)?window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY):null;
    const DEFAULT_TYPES=["研究区域图","箱线图","散点图","折线图","柱状图","热图","PCA图","NMDS图","RDA/CCA图","物种组成图","稀释曲线","其他"];
    const CUSTOM_TYPES_KEY="eco_custom_types_v1";
    const ADMIN_USERS_TABLE="admin_users";
    const OTP_FUNCTION_URL=`${SUPABASE_URL}/functions/v1/admin-destructive-action`;
    const OTP_TARGET_EMAIL="jiangqihao1234@gmail.com";
    let figures=[],activeFilter="all",detailId=null,pendingDocx=[],pendingImage="",isDocxImporting=false,isManualUploading=false;
    let customTypes=[],isAdmin=false,currentUser=null,authStateSubscription=null;

    window.addEventListener("error",function(e){
      const msg="脚本错误："+(e&&e.message?e.message:"未知错误");
      console.error(e);
      try{showToast(msg,"error");}catch(_){}
    });
    window.addEventListener("unhandledrejection",function(e){
      const msg="脚本异常："+(e&&e.reason&&e.reason.message?e.reason.message:String(e.reason||"未知错误"));
      console.error(e);
      try{showToast(msg,"error");}catch(_){}
    });

    document.addEventListener("DOMContentLoaded",init);
    async function init(){
      try{
        loadCustomTypes();
        fillTypeSelect();
        bindEvents();
        syncAdminUI();
        await initAdminAuth();
        await loadData();
        renderAll();
        if(sbClient){showToast("已连接 Supabase 云端存储");}
      }catch(err){
        const msg="初始化失败："+((err&&err.message)?err.message:"未知错误");
        console.error(err);
        showToast(msg,"error");
      }
    }

    function bindEvents(){
      document.querySelectorAll("[data-page]").forEach(el=>{
        el.addEventListener("click",e=>{
          e.preventDefault();
          showPage(el.getAttribute("data-page"));
        });
      });
      const searchInput=document.getElementById("searchInput");
      const importJsonInput=document.getElementById("importJsonInput");
      const manualForm=document.getElementById("manualForm");
      const addTypeBtn=document.getElementById("addTypeBtn");
      const newTypeInput=document.getElementById("newTypeInput");
      const manualReference=document.getElementById("manualReference");
      const adminToggleBtn=document.getElementById("adminToggleBtn");
      if(searchInput){searchInput.addEventListener("input",renderGallery);}
      if(importJsonInput){importJsonInput.addEventListener("change",importJsonData);}
      if(manualForm){manualForm.addEventListener("submit",submitManualFigure);}
      if(addTypeBtn){addTypeBtn.addEventListener("click",addCustomType);}
      if(newTypeInput){
        newTypeInput.addEventListener("input",syncTypeChoiceUI);
        newTypeInput.addEventListener("keydown",e=>{
          if(e.key==="Enter"){e.preventDefault();addCustomType();}
        });
      }
      const manualType=document.getElementById("manualType");
      if(manualType){
        manualType.addEventListener("change",()=>{
          const input=document.getElementById("newTypeInput");
          if(manualType.value && input && clean(input.value)){input.value="";}
          syncTypeChoiceUI();
        });
      }
      if(manualReference){
        manualReference.addEventListener("blur",()=>autofillReferenceMeta(false));
      }
      if(adminToggleBtn){adminToggleBtn.addEventListener("click",toggleAdminMode);}

      const imgZone=document.getElementById("imageDropzone");
      const imgInput=document.getElementById("imageFileInput");
      if(imgZone&&imgInput){
        imgZone.addEventListener("click",()=>imgInput.click());
        imgInput.addEventListener("change",()=>imgInput.files[0]&&loadManualImage(imgInput.files[0]));
        bindDrop(imgZone,file=>loadManualImage(file),[".png",".jpg",".jpeg",".webp"]);
      }

      const docxZone=document.getElementById("docxDropzone");
      const docxInput=document.getElementById("docxFileInput");
      if(docxZone&&docxInput){
        docxZone.addEventListener("click",()=>docxInput.click());
        docxInput.addEventListener("change",()=>docxInput.files[0]&&handleDocxFile(docxInput.files[0]));
        bindDrop(docxZone,file=>handleDocxFile(file),[".docx"]);
      }

      const modal=document.getElementById("detailModal");
      if(modal){modal.addEventListener("click",e=>{if(e.target===modal)closeDetailModal();});}
      document.addEventListener("keydown",e=>{if(e.key==="Escape")closeDetailModal();});
    }

    function bindDrop(zone,cb,suffixList){
      zone.addEventListener("dragover",e=>{e.preventDefault();zone.classList.add("dragover");});
      zone.addEventListener("dragleave",()=>zone.classList.remove("dragover"));
      zone.addEventListener("drop",e=>{
        e.preventDefault();zone.classList.remove("dragover");
        const file=e.dataTransfer.files[0];if(!file)return;
        const ok=suffixList.some(s=>file.name.toLowerCase().endsWith(s));
        ok?cb(file):showToast("文件类型不支持","error");
      });
    }

    function fillTypeSelect(){
      const select=document.getElementById("manualType");if(!select)return;
      const oldValue=select.value;
      const html=['<option value="">请选择类型</option>'].concat(allTypes().map(t=>`<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`));
      select.innerHTML=html.join("");
      if(oldValue && allTypes().includes(oldValue)){select.value=oldValue;}
      syncTypeChoiceUI();
    }

    function syncTypeChoiceUI(){
      const select=document.getElementById("manualType");
      const input=document.getElementById("newTypeInput");
      if(!select||!input)return;
      const hasNewType=!!clean(input.value);
      if(hasNewType){
        select.value="";
        select.disabled=true;
      }else{
        select.disabled=false;
      }
    }

    function ensureTypeExists(type){
      const normalized=clean(type);
      if(!normalized)return "";
      const existed=allTypes().find(t=>t.toLowerCase()===normalized.toLowerCase());
      if(existed){return existed;}
      customTypes.push(normalized);
      customTypes=[...new Set(customTypes.map(clean).filter(Boolean))];
      saveCustomTypes();
      return normalized;
    }

    function loadCustomTypes(){
      try{
        const raw=localStorage.getItem(CUSTOM_TYPES_KEY);
        const arr=raw?JSON.parse(raw):[];
        customTypes=Array.isArray(arr)?arr.map(clean).filter(Boolean):[];
      }catch(_){
        customTypes=[];
      }
    }

    function saveCustomTypes(){
      localStorage.setItem(CUSTOM_TYPES_KEY,JSON.stringify(customTypes));
    }

    function addCustomType(){
      const input=document.getElementById("newTypeInput");if(!input)return;
      const type=clean(input.value);
      if(!type){showToast("请输入类型名称","error");return;}
      if(type.length>40){showToast("类型名称建议不超过 40 个字符","error");return;}
      const alreadyExists=allTypes().some(t=>t.toLowerCase()===type.toLowerCase());
      const ensuredType=ensureTypeExists(type);
      fillTypeSelect();
      renderTypes("overviewTypeChips");
      renderTypes("galleryTypeChips");
      const select=document.getElementById("manualType");
      if(select){
        select.disabled=false;
        select.value=ensuredType;
      }
      input.value="";
      syncTypeChoiceUI();
      showToast(alreadyExists?"该类型已存在，已自动选中":"已新增类型："+ensuredType);
    }

    async function initAdminAuth(){
      if(!sbClient){
        currentUser=null;
        isAdmin=false;
        return;
      }
      const {data,error}=await sbClient.auth.getSession();
      if(error){
        console.error(error);
        currentUser=null;
      }else{
        currentUser=data&&data.session?data.session.user:null;
      }
      await refreshAdminState();
      if(authStateSubscription&&authStateSubscription.unsubscribe){
        authStateSubscription.unsubscribe();
      }
      const sub=sbClient.auth.onAuthStateChange(async(_,session)=>{
        currentUser=session&&session.user?session.user:null;
        await refreshAdminState();
        syncAdminUI();
      });
      authStateSubscription=sub&&sub.data&&sub.data.subscription?sub.data.subscription:null;
    }

    async function refreshAdminState(){
      if(!sbClient||!currentUser){
        isAdmin=false;
        return;
      }
      const {data,error}=await sbClient
        .from(ADMIN_USERS_TABLE)
        .select("user_id")
        .eq("user_id",currentUser.id)
        .maybeSingle();
      if(error){
        console.error(error);
        isAdmin=false;
        return;
      }
      isAdmin=!!(data&&data.user_id);
    }

    function syncAdminUI(){
      const text=document.getElementById("adminToggleText");
      const state=document.getElementById("adminStateText");
      if(text){text.textContent=isAdmin?"退出管理员":"管理员登录";}
      if(state){
        state.textContent=isAdmin
          ?("管理员模式"+(currentUser&&currentUser.email?(" · "+currentUser.email):""))
          :"访客模式";
      }
      const importBtn=document.getElementById("importJsonBtn");
      const clearBtn=document.getElementById("clearAllDataBtn");
      const delBtn=document.getElementById("deleteFigureBtn");
      applyAdminVisibility(importBtn,isAdmin);
      applyAdminVisibility(clearBtn,isAdmin);
      applyAdminVisibility(delBtn,isAdmin);
    }

    function applyAdminVisibility(node,visible){
      if(!node)return;
      node.hidden=!visible;
      node.style.display=visible?"inline-flex":"none";
    }

    async function toggleAdminMode(){
      if(!sbClient){
        showToast("当前未连接 Supabase，无法管理员登录","error");
        return;
      }
      if(isAdmin){
        const {error}=await sbClient.auth.signOut();
        if(error){
          showToast("退出失败："+(error.message||"未知错误"),"error");
          return;
        }
        currentUser=null;
        isAdmin=false;
        syncAdminUI();
        showToast("已退出管理员模式");
        return;
      }
      const email=clean(prompt("请输入管理员邮箱"));
      if(!email)return;
      const password=prompt("请输入管理员密码");
      if(password===null||password==="")return;
      const {error:loginError}=await sbClient.auth.signInWithPassword({email,password});
      if(loginError){
        showToast("登录失败："+(loginError.message||"未知错误"),"error");
        return;
      }
      const {data:sessionData,error:sessionError}=await sbClient.auth.getSession();
      if(sessionError){
        showToast("登录状态读取失败："+(sessionError.message||"未知错误"),"error");
        return;
      }
      currentUser=sessionData&&sessionData.session?sessionData.session.user:null;
      await refreshAdminState();
      if(!isAdmin){
        await sbClient.auth.signOut();
        currentUser=null;
        syncAdminUI();
        showToast("该账号不是管理员账号","error");
        return;
      }
      syncAdminUI();
      showToast("管理员登录成功");
    }

    async function invokeAdminOtpFunction(payload){
      if(!sbClient) throw new Error("未连接 Supabase");
      const {data,error}=await sbClient.auth.getSession();
      if(error||!data||!data.session||!data.session.access_token){
        throw new Error("管理员登录已失效，请重新登录");
      }
      const resp=await fetch(OTP_FUNCTION_URL,{
        method:"POST",
        headers:{
          "Content-Type":"application/json",
          "apikey":SUPABASE_ANON_KEY,
          "Authorization":"Bearer "+data.session.access_token
        },
        body:JSON.stringify(payload||{})
      });
      let json={};
      try{json=await resp.json();}catch(_){}
      if(!resp.ok){
        const msg=(json&&json.error)?json.error:("请求失败（"+resp.status+"）");
        throw new Error(msg);
      }
      return json;
    }

    async function verifyDestructiveAction(action,extraPayload){
      await refreshAdminState();
      if(!isAdmin) throw new Error("仅管理员可执行此操作");
      await invokeAdminOtpFunction({mode:"send",action});
      const code=clean(prompt("验证码已发送至 "+OTP_TARGET_EMAIL+"，请输入 6 位验证码"));
      if(!code) throw new Error("已取消操作");
      return await invokeAdminOtpFunction({
        mode:"verify_execute",
        action,
        code,
        ...extraPayload
      });
    }

    async function loadData(){
      if(sbClient){
        const {data,error}=await sbClient.from(SUPABASE_TABLE).select("*").order("date_added",{ascending:false});
        if(!error){
          figures=(data||[]).map(fromDbRow).map(norm).filter(Boolean);
          localStorage.setItem(STORAGE_KEY,JSON.stringify(figures));
          return;
        }
        showToast("云端读取失败，已回退本地缓存","error");
      }
      try{
        const raw=localStorage.getItem(STORAGE_KEY);if(!raw){figures=[];return;}
        const arr=JSON.parse(raw);figures=Array.isArray(arr)?arr.map(norm).filter(Boolean):[];
      }catch(_){
        figures=[];
        showToast("本地数据异常，已忽略损坏内容","error");
      }
    }

    async function saveData(){
      if(sbClient){
        if(figures.length===0){
          localStorage.setItem(STORAGE_KEY,"[]");
          updateStats();
          updateFooterDate();
          return true;
        }
        const rows=figures.map(toDbRow);
        const {error}=await sbClient.from(SUPABASE_TABLE).upsert(rows,{onConflict:"id"});
        if(error){
          const msg="云端保存失败："+(error.message||"未知错误");
          alert(msg);
          showToast(msg,"error");
          return false;
        }
      }else{
        try{
          localStorage.setItem(STORAGE_KEY,JSON.stringify(figures));
        }catch(err){
          const msg=(err&&err.name==="QuotaExceededError")
            ?"保存失败：浏览器本地存储空间已满。请先导出 JSON 并清理部分数据后重试。"
            :"保存失败："+((err&&err.message)?err.message:"未知错误");
          alert(msg);
          showToast(msg,"error");
          return false;
        }
      }
      localStorage.setItem(STORAGE_KEY,JSON.stringify(figures));
      updateStats();
      updateFooterDate();
      return true;
    }

    function norm(v){
      if(!v||typeof v!=="object")return null;
      return{
        id:String(v.id||gid()),
        imageSrc:String(v.imageSrc||""),
        storagePath:String(v.storagePath||""),
        type:String(v.type||"其他"),
        title:String(v.title||"无标题"),
        reference:String(v.reference||""),
        year:v.year?String(v.year):"",
        journal:String(v.journal||""),
        keywords:String(v.keywords||""),
        summary:String(v.summary||""),
        dateAdded:String(v.dateAdded||new Date().toISOString())
      };
    }

    function toDbRow(f){
      return {
        id:f.id,
        image_src:f.imageSrc,
        storage_path:f.storagePath||null,
        type:f.type,
        title:f.title,
        reference:f.reference,
        year:f.year||null,
        journal:f.journal||null,
        keywords:f.keywords||null,
        summary:f.summary||null,
        date_added:f.dateAdded
      };
    }

    function fromDbRow(r){
      return {
        id:r.id,
        imageSrc:r.image_src||"",
        storagePath:r.storage_path||"",
        type:r.type||"其他",
        title:r.title||"无标题",
        reference:r.reference||"",
        year:r.year||"",
        journal:r.journal||"",
        keywords:r.keywords||"",
        summary:r.summary||"",
        dateAdded:r.date_added||new Date().toISOString()
      };
    }

    function renderAll(){
      fillTypeSelect();
      updateStats();renderTypes("overviewTypeChips");renderTypes("galleryTypeChips");
      renderRecent();renderGallery();renderReferences();updateFooterDate();
      syncAdminUI();
    }

    function allTypes(){
      const s=new Set(DEFAULT_TYPES);
      customTypes.forEach(t=>t&&s.add(t));
      figures.forEach(f=>f.type&&s.add(f.type));
      return [...s];
    }

    function renderTypes(id){
      const c=document.getElementById(id);
      const a=[`<button class="chip ${activeFilter==="all"?"active":""}" onclick="setFilter('all')">全部类型</button>`];
      allTypes().forEach(t=>a.push(`<button class="chip ${activeFilter===t?"active":""}" onclick="setFilter('${escapeJs(t)}')">${escapeHtml(t)}</button>`));
      c.innerHTML=a.join("");
    }

    function setFilter(v){activeFilter=v;renderTypes("overviewTypeChips");renderTypes("galleryTypeChips");renderGallery();}
    function searchText(){return document.getElementById("searchInput").value.trim().toLowerCase();}

    function visibleFigures(){
      const q=searchText();
      return figures.filter(f=>{
        const pass=activeFilter==="all"||f.type===activeFilter;if(!pass)return false;
        if(!q)return true;
        return f.title.toLowerCase().includes(q)||f.reference.toLowerCase().includes(q)||f.keywords.toLowerCase().includes(q)||f.type.toLowerCase().includes(q);
      });
    }

    function renderRecent(){
      const c=document.getElementById("recentGrid");
      if(!figures.length){c.innerHTML='<div class="empty" style="grid-column:1/-1">暂无结果图，请到“上传/更新”添加。</div>';return;}
      const list=figures.slice().sort((a,b)=>new Date(b.dateAdded)-new Date(a.dateAdded)).slice(0,6);
      c.innerHTML=list.map(card).join("");
    }

    function renderGallery(){
      const c=document.getElementById("galleryGrid"),list=visibleFigures();
      c.innerHTML=list.length?list.map(card).join(""):'<div class="empty" style="grid-column:1/-1">没有匹配结果图，请调整筛选或上传新图。</div>';
    }

    function card(f){
      const img=f.imageSrc?`<img src="${escapeHtml(f.imageSrc)}" alt="${escapeHtml(f.title)}">`:'<i class="fa-regular fa-image"></i>';
      return `<article class="card" onclick="openDetailModal('${escapeJs(f.id)}')"><div class="thumb">${img}</div><div class="body"><span class="type">${escapeHtml(f.type)}</span><h3>${escapeHtml(f.title)}</h3><p>${escapeHtml(f.reference)}</p><div class="row"><button class="btn secondary" onclick="event.stopPropagation();downloadFigure('${escapeJs(f.id)}')"><i class="fa-solid fa-download"></i>下载</button><button class="btn primary" onclick="event.stopPropagation();openDetailModal('${escapeJs(f.id)}')"><i class="fa-solid fa-eye"></i>详情</button></div></div></article>`;
    }

    function updateStats(){
      const t=new Set(figures.map(f=>f.type).filter(Boolean)),r=new Set(figures.map(f=>f.reference).filter(Boolean));
      const d=figures.length?new Date(Math.max(...figures.map(f=>new Date(f.dateAdded).getTime()))).toLocaleDateString("zh-CN"):"--";
      document.getElementById("statTypes").textContent=t.size;
      document.getElementById("statFigures").textContent=figures.length;
      document.getElementById("statRefs").textContent=r.size;
      document.getElementById("statDate").textContent=d;
    }

    function updateFooterDate(){
      const d=figures.length?new Date(Math.max(...figures.map(f=>new Date(f.dateAdded).getTime()))).toLocaleDateString("zh-CN"):"--";
      document.getElementById("footerDate").textContent=d;
    }

    function renderReferences(){
      const c=document.getElementById("referenceList");
      if(!figures.length){c.innerHTML='<div class="empty">暂无文献数据。</div>';return;}
      const g={};figures.forEach(f=>{const k=f.reference||"未填写文献信息";(g[k]||(g[k]=[])).push(f);});
      c.innerHTML=Object.keys(g).map(k=>{
        const a=g[k];
        const yearItem=a.find(function(v){return !!v.year;});
        const journalItem=a.find(function(v){return !!v.journal;});
        const y=yearItem?yearItem.year:"--";
        const j=journalItem?journalItem.journal:"--";
        return `<div class="ref-item"><h3>${escapeHtml(k)}</h3><p>结果图数量：${a.length} 张 | 年份：${escapeHtml(y)} | 期刊：${escapeHtml(j)}</p></div>`;
      }).join("");
    }

    function showPage(name){
      document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));
      const t=document.getElementById("page-"+name);if(!t)return;t.classList.add("active");
      document.querySelectorAll(".nav button").forEach(b=>b.classList.toggle("active",b.getAttribute("data-page")===name));
      if(name==="overview")renderRecent();else if(name==="gallery")renderGallery();else if(name==="references")renderReferences();
      window.scrollTo({top:0,behavior:"smooth"});
    }

    function loadManualImage(file){
      if(!file.type.startsWith("image/")){showToast("请选择图片文件","error");return;}
      if(file.size>10*1024*1024){showToast("图片不能超过 10MB","error");return;}
      const r=new FileReader();
      r.onload=e=>{
        pendingImage=String(e.target.result||"");
        const p=document.getElementById("imagePreview");
        p.innerHTML=`<img src="${escapeHtml(pendingImage)}" alt="预览">`;
        p.classList.add("active");
      };
      r.readAsDataURL(file);
    }

    async function submitManualFigure(e){
      e.preventDefault();
      if(isManualUploading)return;
      if(!pendingImage){showToast("请先上传图片","error");return;}
      const selectType=document.getElementById("manualType").value.trim();
      const typedType=clean(document.getElementById("newTypeInput").value);
      let type=typedType||selectType;
      if(typedType){
        type=ensureTypeExists(typedType);
        fillTypeSelect();
      }
      const title=document.getElementById("manualTitle").value.trim();
      const reference=document.getElementById("manualReference").value.trim();
      const parsedMeta=parseReferenceMeta(reference);
      const year=(document.getElementById("manualYear").value.trim()||parsedMeta.year||"");
      const journal=(document.getElementById("manualJournal").value.trim()||parsedMeta.journal||"");
      if(!type||!title||!reference){showToast("请填写所有必填项","error");return;}
      isManualUploading=true;
      let uploadedPath="";
      try{
        const uploaded=await uploadDataUrlToStorage(pendingImage,"manual");
        uploadedPath=uploaded.path||"";
        const nextFigure=norm({
          id:gid(),
          imageSrc:uploaded.publicUrl,
          storagePath:uploaded.path||"",
          type,title,reference,year,journal,keywords:"",summary:"",
          dateAdded:new Date().toISOString()
        });
        figures.push(nextFigure);
        if(!await saveData()){
          figures.pop();
          if(uploadedPath){await deleteStoragePaths([uploadedPath]);}
          return;
        }
        renderAll();
        e.target.reset();pendingImage="";
        document.getElementById("manualType").disabled=false;
        syncTypeChoiceUI();
        document.getElementById("imagePreview").innerHTML="";
        document.getElementById("imagePreview").classList.remove("active");
        document.getElementById("imageFileInput").value="";
        alert("添加结果图成功。");
        showToast("上传成功");
        showPage("gallery");
      }catch(err){
        if(uploadedPath){await deleteStoragePaths([uploadedPath]);}
        alert("上传失败："+((err&&err.message)?err.message:"未知错误"));
        showToast("上传失败","error");
      }finally{
        isManualUploading=false;
      }
    }

    async function handleDocxFile(file){
      if(!file.name.toLowerCase().endsWith(".docx")){showToast("请上传 .docx 文件","error");return;}
      if(typeof mammoth==="undefined"){showToast("DOCX 解析库加载失败","error");return;}
      const r=new FileReader();
      r.onload=async e=>{
        try{
          const opt={
            styleMap:[
              "p[style-name='Heading 1'] => h1:fresh",
              "p[style-name='Heading 2'] => h2:fresh",
              "p[style-name='Heading 3'] => h3:fresh",
              "p[style-name='Heading1'] => h1:fresh",
              "p[style-name='Heading2'] => h2:fresh",
              "p[style-name='Heading3'] => h3:fresh",
              "p[style-name='标题 1'] => h1:fresh",
              "p[style-name='标题 2'] => h2:fresh",
              "p[style-name='标题 3'] => h3:fresh",
              "p[style-name='标题1'] => h1:fresh",
              "p[style-name='标题2'] => h2:fresh",
              "p[style-name='标题3'] => h3:fresh",
              "p[style-name='1 级'] => h1:fresh",
              "p[style-name='1级'] => h1:fresh",
              "p[style-name='级别 1'] => h1:fresh",
              "p[style-name='级别1'] => h1:fresh",
              "p[style-name='大纲级别 1'] => h1:fresh",
              "p[style-name='大纲级别1'] => h1:fresh"
            ],
            convertImage:mammoth.images.imgElement(image=>image.read("base64").then(base64=>({src:"data:"+image.contentType+";base64,"+base64})))
          };
          const res=await mammoth.convertToHtml({arrayBuffer:e.target.result},opt);
          const list=parseDocxHtml(res.value);
          if(!list.length){showToast("未识别到图片，请检查文档格式","error");return;}
          pendingDocx=list;
          renderDocxPreview(list);
          showToast("文档解析成功，请确认导入");
        }catch(err){
          showToast("文档解析失败："+(err.message||"未知错误"),"error");
        }
      };
      r.readAsArrayBuffer(file);
    }

    function parseDocxHtml(html){
      const doc=new DOMParser().parseFromString("<body>"+html+"</body>","text/html");
      const blocks=[...doc.body.querySelectorAll("h1,h2,h3,p,li,figcaption,img")];
      let currentType="其他",currentSummary="",currentReference="";
      let textBuffer=[],lastFigureIndex=-1;
      const out=[];

      blocks.forEach(node=>{
        const tag=node.tagName.toLowerCase();
        if(tag==="img"){
          const src=node.getAttribute("src")||"";
          if(!src.startsWith("data:")) return;
          const refFromBuffer=textBuffer.find(looksLikeReference) || "";
          const titleFromBuffer=pickTitleFromBuffer(textBuffer);
          const parsedMeta=parseReferenceMeta(currentReference||refFromBuffer||"");
          const figure=norm({
            id:gid(),
            imageSrc:src,
            type:currentType||"其他",
            title:titleFromBuffer || "未命名图题",
            reference:(currentReference||refFromBuffer||""),
            year:parsedMeta.year||"",
            journal:parsedMeta.journal||"",
            keywords:"",
            summary:currentSummary||"",
            dateAdded:new Date().toISOString()
          });
          out.push(figure);
          lastFigureIndex=(!titleFromBuffer ? out.length-1 : -1);
          textBuffer=[];
          return;
        }

        const text=textWithoutImages(node);
        if(!text) return;

        const level=getHeadingLevel(node,text);
        if(level===1){
          const parsedType=extractType(text)||normalizeTypeText(text)||text||"其他";
          currentType=ensureTypeExists(parsedType);
          currentSummary="";
          currentReference="";
          textBuffer=[];
          lastFigureIndex=-1;
          return;
        }
        if(level===2){
          currentSummary=text;
          textBuffer=[];
          lastFigureIndex=-1;
          return;
        }
        if(level===3){
          currentReference=text;
          textBuffer=[];
          lastFigureIndex=-1;
          return;
        }

        const guessedType=extractType(text);
        if(guessedType && currentType==="其他"){
          currentType=ensureTypeExists(guessedType);
        }

        if(looksLikeReference(text)){
          currentReference=text;
          return;
        }

        const inlineTitle=extractTitleHint(text);
        const normalText=inlineTitle || text;
        if(lastFigureIndex>=0 && out[lastFigureIndex] && out[lastFigureIndex].title==="未命名图题"){
          out[lastFigureIndex].title=normalText;
          lastFigureIndex=-1;
        }else{
          textBuffer.push(normalText);
        }
      });

      return out;
    }

    function getHeadingLevel(node,text){
      const tag=node.tagName.toLowerCase();
      if(tag==="h1") return 1;
      if(tag==="h2") return 2;
      if(tag==="h3") return 3;
      if(looksLikeLooseTypeHeading(text)) return 1;
      if(isTypeHeadingText(text)) return 1;
      return 0;
    }

    function isTypeHeadingText(text){
      const t=clean(text);
      if(!t) return false;
      if(/^(结果图)?类型[：:]\s*.+$/.test(t)) return true;
      if(looksLikeLooseTypeHeading(t)) return true;
      const types=allTypes();
      if(types.includes(t)) return true;
      return types.some(type=>t===("【"+type+"】") || t.startsWith(type+" "));
    }

    function normalizeTypeText(text){
      let t=clean(text);
      if(!t) return "";
      t=t.replace(/^[•▪■◆●\-\*·]+\s*/,"").trim();
      t=t.replace(/^[（(]?[一二三四五六七八九十0-9]+[)）.、]\s*/,"").trim();
      const wrapped=t.match(/^【\s*(.+?)\s*】$/);
      if(wrapped){t=clean(wrapped[1]);}
      const explicit=t.match(/^(?:结果图)?类型[：:]\s*(.+)$/);
      if(explicit){t=clean(explicit[1]);}
      return t;
    }

    function looksLikeLooseTypeHeading(text){
      const raw=clean(text);
      if(!raw) return false;
      if(/^【.+】$/.test(raw)) return false;
      const t=normalizeTypeText(raw);
      if(!t) return false;
      if(looksLikeReference(t)) return false;
      if(/[，,。；;]/.test(t)) return false;
      if(t.length>28) return false;
      if(/^(图|表)\s*\d+/i.test(t)) return false;
      if(allTypes().includes(t)) return true;
      return /(图|示意|流程|概括|框架|模型|结构|分布|网络)/.test(t);
    }

    function extractType(text){
      const t=clean(text);
      if(!t) return "";
      const matched=t.match(/^(?:结果图)?类型[：:]\s*(.+)$/);
      const source=matched?clean(matched[1]):normalizeTypeText(t);
      const types=allTypes();
      for(const type of types){
        if(source===type || source.includes(type)) return type;
      }
      if(matched && source) return source;
      if(looksLikeLooseTypeHeading(source)) return source;
      return "";
    }

    function looksLikeReference(text){
      const t=clean(text);
      if(!t) return false;
      if(/^\[\d+\]/.test(t)) return true;
      if(/(等|等人).{0,8}(19|20)\d{2}/.test(t)) return true;
      if(/(期刊|学报|杂志)/.test(t) && /\b(19|20)\d{2}\b/.test(t)) return true;
      if(/(et al\.|doi|journal|letters|indicators|frontiers|ecology|science)/i.test(t) && /\b(19|20)\d{2}\b/.test(t)) return true;
      if(/\b(19|20)\d{2}\b/.test(t) && /[A-Za-z]/.test(t) && t.length>40) return true;
      return false;
    }

    function parseReferenceMeta(reference){
      const text=clean(reference);
      if(!text)return {year:"",journal:""};
      const years=text.match(/\b(19|20)\d{2}\b/g);
      let year=years&&years.length?years[years.length-1]:"";
      let journal="";
      const gbt=text.match(/\[J\]\.?\s*([^,，。]+?)\s*[,，]\s*((19|20)\d{2})/i);
      if(gbt){
        journal=clean(gbt[1]);
        if(!year)year=gbt[2];
      }
      if(!journal){
        const candidates=[...text.matchAll(/([^,，。\[\]]{2,80})\s*[,，]\s*((19|20)\d{2})/g)];
        if(candidates.length){
          const last=candidates[candidates.length-1];
          journal=clean(last[1]);
          if(!year)year=last[2];
        }
      }
      journal=journal.replace(/\s*\[J\]\s*$/i,"").trim();
      return {year,journal};
    }

    function autofillReferenceMeta(force){
      const refInput=document.getElementById("manualReference");
      const yearInput=document.getElementById("manualYear");
      const journalInput=document.getElementById("manualJournal");
      if(!refInput||!yearInput||!journalInput)return;
      const meta=parseReferenceMeta(refInput.value);
      if(meta.year && (force||!yearInput.value.trim())){yearInput.value=meta.year;}
      if(meta.journal && (force||!journalInput.value.trim())){journalInput.value=meta.journal;}
    }

    function extractTitleHint(text){
      const t=clean(text);
      const m=t.match(/图题[：:]\s*(.+)$/);
      return m?clean(m[1]):"";
    }

    function pickTitleFromBuffer(buffer){
      const candidates=buffer.map(clean).filter(Boolean).filter(v=>!looksLikeReference(v));
      if(!candidates.length) return "";
      return candidates[candidates.length-1];
    }

    function textWithoutImages(node){
      const c=node.cloneNode(true);
      c.querySelectorAll("img").forEach(img=>img.remove());
      return clean(c.textContent);
    }
    function clean(s){
      return String(s||"")
        .replace(/[↵\u00A0]/g," ")
        .replace(/[•▪■◆●]/g," ")
        .replace(/\s+/g," ")
        .trim();
    }

    async function uploadDataUrlToStorage(dataUrl,prefix){
      if(!sbClient||!dataUrl||!dataUrl.startsWith("data:")){
        return {publicUrl:dataUrl||"",path:""};
      }
      const match=dataUrl.match(/^data:([^;]+);base64,/i);
      const contentType=match?match[1]:"application/octet-stream";
      const blob=await fetch(dataUrl).then(r=>r.blob());
      const ext=(contentType.split("/")[1]||"bin").replace(/[^a-zA-Z0-9]/g,"");
      const path=`${prefix}/${Date.now()}_${Math.random().toString(36).slice(2,8)}.${ext}`;
      const {error}=await sbClient.storage.from(SUPABASE_BUCKET).upload(path,blob,{contentType,upsert:false});
      if(error)throw error;
      const {data}=sbClient.storage.from(SUPABASE_BUCKET).getPublicUrl(path);
      return {publicUrl:data.publicUrl,path};
    }

    async function deleteStoragePaths(paths){
      if(!sbClient)return;
      const valid=(paths||[]).filter(Boolean);
      if(!valid.length)return;
      for(const group of chunk(valid,100)){
        await sbClient.storage.from(SUPABASE_BUCKET).remove(group);
      }
    }

    function chunk(arr,size){
      const out=[];
      for(let i=0;i<arr.length;i+=size){out.push(arr.slice(i,i+size));}
      return out;
    }

    function renderDocxPreview(list){
      const box=document.getElementById("docxPreview"),c=document.getElementById("docxList");
      c.innerHTML=list.map((f,i)=>`<div class="docx-item"><img src="${escapeHtml(f.imageSrc)}" alt="图${i+1}"><div><small>${escapeHtml(f.type)}</small><div style="font-size:13px">${escapeHtml(f.title)}</div><div style="font-size:12px;color:var(--muted)">${escapeHtml(f.reference||"未填写文献")}</div></div></div>`).join("");
      box.classList.add("active");
    }

    async function confirmImportDocx(){
      if(isDocxImporting) return;
      if(!pendingDocx.length){showToast("没有可导入的数据","error");return;}
      isDocxImporting=true;
      const btn=document.getElementById("confirmDocxBtn");
      const oldText=btn?btn.innerHTML:"";
      if(btn){btn.disabled=true;btn.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i> 导入中';}
      const uploadedPaths=[];
      try{
        const mapped=[];
        for(const fig of pendingDocx){
          let imageSrc=fig.imageSrc||"";
          let storagePath=fig.storagePath||"";
          if(imageSrc.startsWith("data:")){
            const uploaded=await uploadDataUrlToStorage(imageSrc,"docx");
            imageSrc=uploaded.publicUrl;
            storagePath=uploaded.path||"";
            if(storagePath){uploadedPaths.push(storagePath);}
          }
          mapped.push(norm({
            ...fig,
            id:fig.id||gid(),
            imageSrc,
            storagePath,
            dateAdded:new Date().toISOString()
          }));
        }
        const importCount=mapped.length;
        const oldLength=figures.length;
        figures=figures.concat(mapped);
        if(!await saveData()){
          figures=figures.slice(0,oldLength);
          await deleteStoragePaths(uploadedPaths);
          return;
        }
        renderAll();
        cancelDocxPreview();
        showPage("gallery");
        alert("导入成功，共导入 "+importCount+" 张结果图。");
        showToast("已导入 "+importCount+" 张结果图");
      }catch(err){
        await deleteStoragePaths(uploadedPaths);
        alert("导入失败："+((err&&err.message)?err.message:"未知错误"));
        showToast("导入失败","error");
      }finally{
        isDocxImporting=false;
        if(btn){btn.disabled=false;btn.innerHTML=oldText||'<i class="fa-solid fa-check"></i> 确认导入';}
      }
    }

    function cancelDocxPreview(){
      pendingDocx=[];document.getElementById("docxPreview").classList.remove("active");
      document.getElementById("docxList").innerHTML="";document.getElementById("docxFileInput").value="";
    }

    function openDetailModal(id){
      const f=figures.find(v=>v.id===id);if(!f)return;detailId=id;
      document.getElementById("detailImage").src=f.imageSrc||"";
      document.getElementById("detailType").textContent=f.type||"--";
      document.getElementById("detailTitle").textContent=f.title||"--";
      document.getElementById("detailReference").textContent=f.reference||"--";
      document.getElementById("detailYear").textContent=f.year||"--";
      document.getElementById("detailJournal").textContent=f.journal||"--";
      document.getElementById("detailModal").classList.add("active");
      syncAdminUI();
    }

    function closeDetailModal(){detailId=null;document.getElementById("detailModal").classList.remove("active");}
    function downloadFigure(id){
      const f=figures.find(v=>v.id===id);if(!f||!f.imageSrc){showToast("该结果图没有可下载图片","error");return;}
      const a=document.createElement("a");a.href=f.imageSrc;a.download=safeName((f.title||"结果图")+".png");a.click();
    }
    function downloadCurrentFigure(){if(detailId)downloadFigure(detailId);}
    async function deleteCurrentFigure(){
      if(!isAdmin){showToast("仅管理员可删除数据","error");return;}
      if(!detailId)return;
      if(!confirm("确认删除这张结果图吗？"))return;
      try{
        await verifyDestructiveAction("delete_one",{figureId:detailId});
        await loadData();
        renderAll();
        closeDetailModal();
        showToast("已删除");
      }catch(err){
        const msg=(err&&err.message)?err.message:"删除失败";
        if(msg!=="已取消操作"){showToast(msg,"error");}
      }
    }
    function copyDetailTitle(){
      const t=document.getElementById("detailTitle").textContent||"";
      navigator.clipboard.writeText(t).then(()=>showToast("图题已复制")).catch(()=>showToast("复制失败，请手动复制","error"));
    }

    function exportJsonData(){
      const blob=new Blob([JSON.stringify(figures,null,2)],{type:"application/json"});
      const url=URL.createObjectURL(blob),a=document.createElement("a");
      a.href=url;a.download="生态学结果图数据_"+new Date().toISOString().slice(0,10)+".json";a.click();URL.revokeObjectURL(url);
      showToast("JSON 导出成功");
    }

    function importJsonData(e){
      if(!isAdmin){
        showToast("仅管理员可导入并覆盖数据","error");
        e.target.value="";
        return;
      }
      const file=e.target.files[0];if(!file)return;
      const r=new FileReader();
      r.onload=async v=>{
        try{
          const p=JSON.parse(String(v.target.result||"[]"));
          const arr=Array.isArray(p)?p:p.figures;
          if(!Array.isArray(arr))throw new Error("JSON 格式错误");
          const next=arr.map(norm).filter(Boolean);
          if(sbClient){
            const {error:delErr}=await sbClient.from(SUPABASE_TABLE).delete().neq("id","");
            if(delErr)throw delErr;
            if(next.length){
              const rows=next.map(toDbRow);
              for(const group of chunk(rows,200)){
                const {error:insErr}=await sbClient.from(SUPABASE_TABLE).insert(group);
                if(insErr)throw insErr;
              }
            }
          }else{
            figures=next;
            if(!await saveData())return;
          }
          figures=next;
          localStorage.setItem(STORAGE_KEY,JSON.stringify(figures));
          renderAll();
          showToast("JSON 导入成功");
        }catch(err){
          showToast("JSON 导入失败："+((err&&err.message)?err.message:""),"error");
        }
        e.target.value="";
      };
      r.readAsText(file,"utf-8");
    }

    async function clearAllData(){
      if(!isAdmin){showToast("仅管理员可清空数据","error");return;}
      if(!confirm("确认清空全部数据？该操作不可恢复。"))return;
      try{
        await verifyDestructiveAction("clear_all",{});
        figures=[];
        localStorage.setItem(STORAGE_KEY,"[]");
        await loadData();
        renderAll();
        cancelDocxPreview();
        pendingImage="";
        document.getElementById("imagePreview").innerHTML="";
        document.getElementById("imagePreview").classList.remove("active");
        showToast("数据已清空");
      }catch(err){
        const msg=(err&&err.message)?err.message:"清空失败";
        if(msg!=="已取消操作"){showToast(msg,"error");}
      }
    }

    function gid(){return "fig_"+Date.now()+"_"+Math.random().toString(36).slice(2,8);}
    function showToast(msg,type){const t=document.getElementById("toast");t.textContent=msg;t.className="toast "+(type||"");setTimeout(()=>t.classList.add("show"),10);setTimeout(()=>t.classList.remove("show"),2300);}
    function safeName(s){return String(s||"figure.png").replace(/[\\/:*?\"<>|]/g,"_");}
    function escapeHtml(s){return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;").replace(/'/g,"&#39;");}
    function escapeJs(s){return String(s||"").replace(/\\/g,"\\\\").replace(/'/g,"\\'");}
  </script>
</body>
</html>
