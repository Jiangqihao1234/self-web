<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>生态学论文结果图谱库</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&family=Noto+Serif+SC:wght@600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
  <style>
    :root{--bg:#f5f7f4;--card:#fff;--line:#d4ded7;--text:#133328;--muted:#607368;--pri:#0f4f3b;--soft:#e9f3ee;--danger:#b42318}
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:"Noto Sans SC",sans-serif;background:var(--bg);color:var(--text)}
    .container{width:min(1180px,95%);margin:0 auto}
    .header{position:sticky;top:0;background:#f5f7f4f0;border-bottom:1px solid var(--line);backdrop-filter:blur(6px);z-index:30}
    .header-inner{height:72px;display:flex;align-items:center;justify-content:space-between;gap:10px}
    .brand{display:flex;align-items:center;gap:10px;cursor:pointer}
    .brand i{width:38px;height:38px;border-radius:10px;background:linear-gradient(135deg,#0f5a44,#2f7a5f);color:#fff;display:grid;place-items:center}
    .brand span{font-family:"Noto Serif SC",serif;font-size:22px;font-weight:700}
    .nav{display:flex;gap:6px;flex-wrap:wrap}
    .nav button{background:transparent;border:1px solid transparent;color:var(--muted);padding:8px 14px;border-radius:999px;cursor:pointer}
    .nav button.active,.nav button:hover{background:var(--soft);border-color:var(--line);color:var(--pri)}
    .search{position:relative;width:270px;max-width:42vw}
    .search i{position:absolute;left:11px;top:50%;transform:translateY(-50%);color:#809589}
    .search input{width:100%;padding:10px 12px 10px 34px;border:1px solid var(--line);border-radius:999px}
    .main{padding:26px 0 40px}
    .page{display:none}.page.active{display:block}
    .hero{text-align:center;margin-bottom:22px}
    .hero h1{font-family:"Noto Serif SC",serif;font-size:clamp(28px,4vw,39px);margin-bottom:8px}
    .hero p{color:var(--muted);max-width:820px;margin:0 auto}
    .stats{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin:18px 0}
    .stat{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:16px;text-align:center}
    .stat i{color:var(--pri)}.stat strong{display:block;font-size:30px;color:var(--pri)}.stat span{font-size:13px;color:var(--muted)}
    .quick{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-bottom:18px}
    .btn{border:none;border-radius:999px;padding:10px 16px;font-size:14px;cursor:pointer;display:inline-flex;align-items:center;gap:8px}
    .btn.primary{background:var(--pri);color:#fff}.btn.secondary{background:#fff;border:1px solid var(--line);color:var(--pri)}.btn.danger{background:#fff3f2;border:1px solid #f3d0cc;color:var(--danger)}
    .panel{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:16px;margin-bottom:14px}
    .panel h2{font-size:17px;margin-bottom:10px}
    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{border:1px solid var(--line);border-radius:999px;background:#fff;color:var(--muted);padding:6px 12px;font-size:13px;cursor:pointer}
    .chip.active{background:var(--pri);border-color:var(--pri);color:#fff}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px}
    .card{border:1px solid var(--line);border-radius:12px;overflow:hidden;background:#fff;cursor:pointer}
    .thumb{height:180px;background:#ecf2ee;display:grid;place-items:center;color:#6d8579;overflow:hidden}
    .thumb img{width:100%;height:100%;object-fit:cover}
    .body{padding:11px}.type{display:inline-block;background:var(--soft);color:var(--pri);border-radius:999px;padding:2px 10px;font-size:12px;margin-bottom:7px}
    .body h3{font-size:15px;margin-bottom:6px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
    .body p{font-size:13px;color:var(--muted);min-height:38px}
    .row{display:flex;gap:8px;margin-top:8px}.row .btn{flex:1;justify-content:center;padding:8px 10px;font-size:13px}
    .empty{border:1px dashed var(--line);border-radius:12px;padding:30px 14px;text-align:center;color:var(--muted)}
    .field{margin-bottom:10px}.field label{display:block;font-size:13px;margin-bottom:5px}
    .field input,.field select,.field textarea{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;font-size:14px;font-family:inherit}
    .field textarea{min-height:90px;resize:vertical}
    .dropzone{border:2px dashed #c0d2c9;border-radius:12px;padding:22px;text-align:center;background:#f8fbf9;cursor:pointer}
    .dropzone.dragover{border-color:var(--pri);background:#eef7f2}
    .preview{margin-top:8px;display:none}.preview.active{display:block}.preview img{width:170px;height:130px;object-fit:cover;border:1px solid var(--line);border-radius:8px}
    .docx-list{display:grid;gap:8px;max-height:280px;overflow:auto;margin-top:8px}
    .docx-item{display:grid;grid-template-columns:72px 1fr;gap:8px;border:1px solid var(--line);border-radius:10px;padding:7px}
    .docx-item img{width:72px;height:54px;object-fit:cover;border-radius:6px}
    .ref-item{border:1px solid var(--line);border-radius:10px;padding:10px;margin-bottom:8px}
    .ref-item p{font-size:13px;color:var(--muted)}
    .modal{position:fixed;inset:0;background:#0009;display:none;align-items:center;justify-content:center;padding:18px;z-index:40}
    .modal.active{display:flex}
    .modal-card{width:min(980px,100%);max-height:90vh;overflow:auto;background:#fff;border-radius:12px;padding:14px}
    .modal-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .modal-head button{width:34px;height:34px;border:none;border-radius:50%;background:#eef3f0;cursor:pointer}
    .modal img{width:100%;max-height:420px;object-fit:contain;background:#f3f7f5;border:1px solid var(--line);border-radius:8px}
    .meta{display:grid;gap:7px;margin-top:10px}.meta b{display:inline-block;min-width:68px;color:#355c4e}
    .footer{text-align:center;color:var(--muted);font-size:13px;padding:18px 0 34px}
    .toast{position:fixed;right:16px;bottom:16px;background:#124434;color:#fff;padding:10px 13px;border-radius:10px;opacity:0;transform:translateY(8px);transition:.2s;z-index:50}
    .toast.show{opacity:1;transform:none}.toast.error{background:#b42318}
    @media (max-width:960px){.header-inner{height:auto;padding:10px 0;flex-wrap:wrap}.search{width:100%;max-width:none}.stats{grid-template-columns:repeat(2,1fr)}}
  </style>
</head>
<body>
  <header class="header">
    <div class="container header-inner">
      <div class="brand" data-page="overview"><i class="fa-solid fa-leaf"></i><span>生态学结果图谱库</span></div>
      <nav class="nav">
        <button class="active" data-page="overview">总览</button>
        <button data-page="gallery">图谱库</button>
        <button data-page="upload">上传/更新</button>
        <button data-page="references">文献库</button>
        <button data-page="about">关于</button>
      </nav>
      <div class="search"><i class="fa-solid fa-magnifying-glass"></i><input id="searchInput" placeholder="搜索图题 / 文献 / 关键词"></div>
    </div>
  </header>
  <main class="main container">
    <section class="page active" id="page-overview">
      <div class="hero">
        <h1>生态学论文结果图谱库</h1>
        <p>用于收集、筛选、展示和分享论文结果图参考素材，支持上传、下载与备份恢复。</p>
      </div>
      <div class="stats">
        <div class="stat"><i class="fa-solid fa-shapes"></i><strong id="statTypes">0</strong><span>结果图类型</span></div>
        <div class="stat"><i class="fa-solid fa-images"></i><strong id="statFigures">0</strong><span>结果图总数</span></div>
        <div class="stat"><i class="fa-solid fa-book"></i><strong id="statRefs">0</strong><span>文献总数</span></div>
        <div class="stat"><i class="fa-solid fa-clock"></i><strong id="statDate">--</strong><span>最近更新</span></div>
      </div>
      <div class="quick">
        <button class="btn primary" onclick="showPage('gallery')"><i class="fa-solid fa-compass"></i>进入图谱库</button>
        <button class="btn secondary" onclick="showPage('upload')"><i class="fa-solid fa-upload"></i>上传更新</button>
      </div>
      <div class="panel"><h2>结果图类型筛选</h2><div class="chips" id="overviewTypeChips"></div></div>
      <div class="panel"><h2>最近更新</h2><div class="grid" id="recentGrid"></div></div>
    </section>
    <section class="page" id="page-gallery">
      <div class="panel"><h2>图谱库</h2><div class="chips" id="galleryTypeChips"></div></div>
      <div class="panel">
        <div class="actions">
          <button class="btn secondary" onclick="exportJsonData()"><i class="fa-solid fa-file-export"></i>导出 JSON</button>
          <button class="btn secondary" onclick="document.getElementById('importJsonInput').click()"><i class="fa-solid fa-file-import"></i>导入 JSON</button>
          <button class="btn danger" onclick="clearAllData()"><i class="fa-solid fa-trash"></i>清空所有数据</button>
          <input id="importJsonInput" type="file" accept=".json,application/json" style="display:none">
        </div>
        <div class="grid" id="galleryGrid"></div>
      </div>
    </section>
    <section class="page" id="page-upload">
      <div class="panel">
        <h2>通过 Word 文档导入（.docx）</h2>
        <p style="color:var(--muted);font-size:13px;margin-bottom:8px">格式约定：H1=结果图类型，H2=结果图内容总结，H3=参考文献信息；H3 下图片为结果图，文字为图题。</p>
        <div id="docxDropzone" class="dropzone"><p><i class="fa-solid fa-cloud-arrow-up"></i> 点击或拖拽上传 Word 文档</p><p style="font-size:12px;color:var(--muted)">支持 .docx</p></div>
        <input id="docxFileInput" type="file" accept=".docx" style="display:none">
        <div id="docxPreview" class="preview">
          <p style="font-size:14px;color:var(--pri)">解析预览（确认后写入图谱库）</p>
          <div id="docxList" class="docx-list"></div>
          <div class="actions" style="margin-top:8px">
            <button class="btn primary" onclick="confirmImportDocx()"><i class="fa-solid fa-check"></i>确认导入</button>
            <button class="btn secondary" onclick="cancelDocxPreview()"><i class="fa-solid fa-xmark"></i>取消</button>
          </div>
        </div>
      </div>
      <div class="panel">
        <h2>手动上传单张结果图</h2>
        <form id="manualForm">
          <div class="field">
            <label>结果图图片 *</label>
            <div id="imageDropzone" class="dropzone"><p><i class="fa-solid fa-upload"></i> 点击或拖拽上传图片</p><p style="font-size:12px;color:var(--muted)">PNG/JPG/JPEG，建议 ≤ 10MB</p></div>
            <input id="imageFileInput" type="file" accept="image/*" style="display:none">
            <div id="imagePreview" class="preview"></div>
          </div>
          <div class="field"><label>结果图类型 *</label><select id="manualType" required></select></div>
          <div class="field"><label>图题 *</label><textarea id="manualTitle" required placeholder="输入完整图题"></textarea></div>
          <div class="field"><label>参考文献信息 *</label><input id="manualReference" required placeholder="如：张三等, 2023, Ecology Letters"></div>
          <div class="field"><label>年份</label><input id="manualYear" type="number" min="1900" max="2100" placeholder="如 2023"></div>
          <div class="field"><label>期刊</label><input id="manualJournal" placeholder="如 Ecology Letters"></div>
          <div class="field"><label>关键词（逗号分隔）</label><input id="manualKeywords" placeholder="如 生物多样性, 群落构建"></div>
          <button class="btn primary" type="submit"><i class="fa-solid fa-plus"></i>添加结果图</button>
        </form>
      </div>
    </section>
    <section class="page" id="page-references"><div class="panel"><h2>文献库</h2><div id="referenceList"></div></div></section>
    <section class="page" id="page-about"><div class="panel"><h2>关于</h2><p>用于收集和分享生态学论文结果图素材。数据保存在浏览器本地，可导出/导入 JSON 做备份恢复。</p></div></section>
  </main>
  <div class="modal" id="detailModal">
    <div class="modal-card">
      <div class="modal-head"><h3>结果图详情</h3><button onclick="closeDetailModal()"><i class="fa-solid fa-xmark"></i></button></div>
      <img id="detailImage" alt="结果图">
      <div class="meta">
        <div><b>类型：</b><span id="detailType"></span></div>
        <div><b>图题：</b><span id="detailTitle"></span></div>
        <div><b>文献：</b><span id="detailReference"></span></div>
        <div><b>年份：</b><span id="detailYear"></span></div>
        <div><b>期刊：</b><span id="detailJournal"></span></div>
        <div><b>关键词：</b><span id="detailKeywords"></span></div>
      </div>
      <div class="actions" style="margin-top:10px">
        <button class="btn secondary" onclick="downloadCurrentFigure()"><i class="fa-solid fa-download"></i>下载图片</button>
        <button class="btn secondary" onclick="copyDetailTitle()"><i class="fa-solid fa-copy"></i>复制图题</button>
        <button class="btn danger" onclick="deleteCurrentFigure()"><i class="fa-solid fa-trash"></i>删除</button>
      </div>
    </div>
  </div>
  <footer class="footer">
    <p>最后更新：<span id="footerDate">--</span></p>
    <p>生态学论文结果图谱库 · 仅用于学习与研究交流</p>
  </footer>
  <div class="toast" id="toast"></div>
  <script>
    const STORAGE_KEY="eco_fig_library_v2";
    const DEFAULT_TYPES=["研究区域图","箱线图","散点图","折线图","柱状图","热图","PCA图","NMDS图","RDA/CCA图","物种组成图","稀释曲线","其他"];
    let figures=[],activeFilter="all",detailId=null,pendingDocx=[],pendingImage="";

    document.addEventListener("DOMContentLoaded",init);
    function init(){
      fillTypeSelect();
      bindEvents();
      loadData();
      renderAll();
    }

    function bindEvents(){
      document.querySelectorAll("[data-page]").forEach(el=>{
        el.addEventListener("click",e=>{
          e.preventDefault();
          showPage(el.getAttribute("data-page"));
        });
      });
      document.getElementById("searchInput").addEventListener("input",renderGallery);
      document.getElementById("importJsonInput").addEventListener("change",importJsonData);
      document.getElementById("manualForm").addEventListener("submit",submitManualFigure);

      const imgZone=document.getElementById("imageDropzone");
      const imgInput=document.getElementById("imageFileInput");
      imgZone.addEventListener("click",()=>imgInput.click());
      imgInput.addEventListener("change",()=>imgInput.files[0]&&loadManualImage(imgInput.files[0]));
      bindDrop(imgZone,file=>loadManualImage(file),[".png",".jpg",".jpeg",".webp"]);

      const docxZone=document.getElementById("docxDropzone");
      const docxInput=document.getElementById("docxFileInput");
      docxZone.addEventListener("click",()=>docxInput.click());
      docxInput.addEventListener("change",()=>docxInput.files[0]&&handleDocxFile(docxInput.files[0]));
      bindDrop(docxZone,file=>handleDocxFile(file),[".docx"]);

      const modal=document.getElementById("detailModal");
      modal.addEventListener("click",e=>{if(e.target===modal)closeDetailModal();});
      document.addEventListener("keydown",e=>{if(e.key==="Escape")closeDetailModal();});
    }

    function bindDrop(zone,cb,suffixList){
      zone.addEventListener("dragover",e=>{e.preventDefault();zone.classList.add("dragover");});
      zone.addEventListener("dragleave",()=>zone.classList.remove("dragover"));
      zone.addEventListener("drop",e=>{
        e.preventDefault();zone.classList.remove("dragover");
        const file=e.dataTransfer.files[0];if(!file)return;
        const ok=suffixList.some(s=>file.name.toLowerCase().endsWith(s));
        ok?cb(file):showToast("文件类型不支持","error");
      });
    }

    function fillTypeSelect(){
      const html=['<option value="">请选择类型</option>'].concat(DEFAULT_TYPES.map(t=>`<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`));
      document.getElementById("manualType").innerHTML=html.join("");
    }

    function loadData(){
      try{
        const raw=localStorage.getItem(STORAGE_KEY);if(!raw){figures=[];return;}
        const arr=JSON.parse(raw);figures=Array.isArray(arr)?arr.map(norm).filter(Boolean):[];
      }catch(_){figures=[];showToast("本地数据异常，已忽略损坏内容","error");}
    }

    function saveData(){
      localStorage.setItem(STORAGE_KEY,JSON.stringify(figures));
      updateStats();updateFooterDate();
    }

    function norm(v){
      if(!v||typeof v!=="object")return null;
      return{
        id:String(v.id||gid()),
        imageSrc:String(v.imageSrc||""),
        type:String(v.type||"其他"),
        title:String(v.title||"无标题"),
        reference:String(v.reference||""),
        year:v.year?String(v.year):"",
        journal:String(v.journal||""),
        keywords:String(v.keywords||""),
        summary:String(v.summary||""),
        dateAdded:String(v.dateAdded||new Date().toISOString())
      };
    }

    function renderAll(){
      updateStats();renderTypes("overviewTypeChips");renderTypes("galleryTypeChips");
      renderRecent();renderGallery();renderReferences();updateFooterDate();
    }

    function allTypes(){
      const s=new Set(DEFAULT_TYPES);figures.forEach(f=>f.type&&s.add(f.type));return [...s];
    }

    function renderTypes(id){
      const c=document.getElementById(id);
      const a=[`<button class="chip ${activeFilter==="all"?"active":""}" onclick="setFilter('all')">全部类型</button>`];
      allTypes().forEach(t=>a.push(`<button class="chip ${activeFilter===t?"active":""}" onclick="setFilter('${escapeJs(t)}')">${escapeHtml(t)}</button>`));
      c.innerHTML=a.join("");
    }

    function setFilter(v){activeFilter=v;renderTypes("overviewTypeChips");renderTypes("galleryTypeChips");renderGallery();}
    function searchText(){return document.getElementById("searchInput").value.trim().toLowerCase();}

    function visibleFigures(){
      const q=searchText();
      return figures.filter(f=>{
        const pass=activeFilter==="all"||f.type===activeFilter;if(!pass)return false;
        if(!q)return true;
        return f.title.toLowerCase().includes(q)||f.reference.toLowerCase().includes(q)||f.keywords.toLowerCase().includes(q)||f.type.toLowerCase().includes(q);
      });
    }

    function renderRecent(){
      const c=document.getElementById("recentGrid");
      if(!figures.length){c.innerHTML='<div class="empty" style="grid-column:1/-1">暂无结果图，请到“上传/更新”添加。</div>';return;}
      const list=figures.slice().sort((a,b)=>new Date(b.dateAdded)-new Date(a.dateAdded)).slice(0,6);
      c.innerHTML=list.map(card).join("");
    }

    function renderGallery(){
      const c=document.getElementById("galleryGrid"),list=visibleFigures();
      c.innerHTML=list.length?list.map(card).join(""):'<div class="empty" style="grid-column:1/-1">没有匹配结果图，请调整筛选或上传新图。</div>';
    }

    function card(f){
      const img=f.imageSrc?`<img src="${escapeHtml(f.imageSrc)}" alt="${escapeHtml(f.title)}">`:'<i class="fa-regular fa-image"></i>';
      return `<article class="card" onclick="openDetailModal('${escapeJs(f.id)}')"><div class="thumb">${img}</div><div class="body"><span class="type">${escapeHtml(f.type)}</span><h3>${escapeHtml(f.title)}</h3><p>${escapeHtml(f.reference)}</p><div class="row"><button class="btn secondary" onclick="event.stopPropagation();downloadFigure('${escapeJs(f.id)}')"><i class="fa-solid fa-download"></i>下载</button><button class="btn primary" onclick="event.stopPropagation();openDetailModal('${escapeJs(f.id)}')"><i class="fa-solid fa-eye"></i>详情</button></div></div></article>`;
    }

    function updateStats(){
      const t=new Set(figures.map(f=>f.type).filter(Boolean)),r=new Set(figures.map(f=>f.reference).filter(Boolean));
      const d=figures.length?new Date(Math.max(...figures.map(f=>new Date(f.dateAdded).getTime()))).toLocaleDateString("zh-CN"):"--";
      document.getElementById("statTypes").textContent=t.size;
      document.getElementById("statFigures").textContent=figures.length;
      document.getElementById("statRefs").textContent=r.size;
      document.getElementById("statDate").textContent=d;
    }

    function updateFooterDate(){
      const d=figures.length?new Date(Math.max(...figures.map(f=>new Date(f.dateAdded).getTime()))).toLocaleDateString("zh-CN"):"--";
      document.getElementById("footerDate").textContent=d;
    }

    function renderReferences(){
      const c=document.getElementById("referenceList");
      if(!figures.length){c.innerHTML='<div class="empty">暂无文献数据。</div>';return;}
      const g={};figures.forEach(f=>{const k=f.reference||"未填写文献信息";(g[k]||(g[k]=[])).push(f);});
      c.innerHTML=Object.keys(g).map(k=>{const a=g[k],y=a.find(v=>v.year)?.year||"--",j=a.find(v=>v.journal)?.journal||"--";return `<div class="ref-item"><h3>${escapeHtml(k)}</h3><p>结果图数量：${a.length} 张 | 年份：${escapeHtml(y)} | 期刊：${escapeHtml(j)}</p></div>`;}).join("");
    }

    function showPage(name){
      document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));
      const t=document.getElementById("page-"+name);if(!t)return;t.classList.add("active");
      document.querySelectorAll(".nav button").forEach(b=>b.classList.toggle("active",b.getAttribute("data-page")===name));
      if(name==="overview")renderRecent();else if(name==="gallery")renderGallery();else if(name==="references")renderReferences();
      window.scrollTo({top:0,behavior:"smooth"});
    }

    function loadManualImage(file){
      if(!file.type.startsWith("image/")){showToast("请选择图片文件","error");return;}
      if(file.size>10*1024*1024){showToast("图片不能超过 10MB","error");return;}
      const r=new FileReader();
      r.onload=e=>{
        pendingImage=String(e.target.result||"");
        const p=document.getElementById("imagePreview");
        p.innerHTML=`<img src="${escapeHtml(pendingImage)}" alt="预览">`;
        p.classList.add("active");
      };
      r.readAsDataURL(file);
    }

    function submitManualFigure(e){
      e.preventDefault();
      if(!pendingImage){showToast("请先上传图片","error");return;}
      const type=document.getElementById("manualType").value.trim();
      const title=document.getElementById("manualTitle").value.trim();
      const reference=document.getElementById("manualReference").value.trim();
      const year=document.getElementById("manualYear").value.trim();
      const journal=document.getElementById("manualJournal").value.trim();
      const keywords=document.getElementById("manualKeywords").value.trim();
      if(!type||!title||!reference){showToast("请填写所有必填项","error");return;}
      figures.push(norm({id:gid(),imageSrc:pendingImage,type,title,reference,year,journal,keywords,summary:"",dateAdded:new Date().toISOString()}));
      saveData();renderAll();
      e.target.reset();pendingImage="";
      document.getElementById("imagePreview").innerHTML="";
      document.getElementById("imagePreview").classList.remove("active");
      document.getElementById("imageFileInput").value="";
      showToast("上传成功");
      showPage("gallery");
    }

    async function handleDocxFile(file){
      if(!file.name.toLowerCase().endsWith(".docx")){showToast("请上传 .docx 文件","error");return;}
      if(typeof mammoth==="undefined"){showToast("DOCX 解析库加载失败","error");return;}
      const r=new FileReader();
      r.onload=async e=>{
        try{
          const opt={convertImage:mammoth.images.imgElement(image=>image.read("base64").then(base64=>({src:"data:"+image.contentType+";base64,"+base64})))};
          const res=await mammoth.convertToHtml({arrayBuffer:e.target.result},opt);
          const list=parseDocxHtml(res.value);
          if(!list.length){showToast("未识别到图片，请检查文档格式","error");return;}
          pendingDocx=list;renderDocxPreview(list);showToast("文档解析成功，请确认导入");
        }catch(err){showToast("文档解析失败："+(err.message||"未知错误"),"error");}
      };
      r.readAsArrayBuffer(file);
    }

    function parseDocxHtml(html){
      const doc=new DOMParser().parseFromString("<body>"+html+"</body>","text/html");
      const blocks=[...doc.body.querySelectorAll("h1,h2,h3,p,li,figcaption,img")];
      let type="其他",summary="",reference="",titleParts=[];
      const out=[];
      blocks.forEach(n=>{
        const tag=n.tagName.toLowerCase();
        if(tag==="h1"){type=clean(n.textContent)||"其他";summary="";reference="";titleParts=[];return;}
        if(tag==="h2"){summary=clean(n.textContent);reference="";titleParts=[];return;}
        if(tag==="h3"){reference=clean(n.textContent);titleParts=[];return;}
        if(tag==="img"){
          const src=n.getAttribute("src")||"";if(!src.startsWith("data:"))return;
          const title=titleParts.length?titleParts.join(" "):"未命名图题";
          out.push(norm({id:gid(),imageSrc:src,type,title,reference,year:"",journal:"",keywords:"",summary,dateAdded:new Date().toISOString()}));
          titleParts=[];return;
        }
        const t=textWithoutImages(n);if(t)titleParts.push(t);
      });
      return out;
    }

    function textWithoutImages(node){
      const c=node.cloneNode(true);c.querySelectorAll("img").forEach(img=>img.remove());return clean(c.textContent);
    }
    function clean(s){return String(s||"").replace(/\s+/g," ").trim();}

    function renderDocxPreview(list){
      const box=document.getElementById("docxPreview"),c=document.getElementById("docxList");
      c.innerHTML=list.map((f,i)=>`<div class="docx-item"><img src="${escapeHtml(f.imageSrc)}" alt="图${i+1}"><div><small>${escapeHtml(f.type)}</small><div style="font-size:13px">${escapeHtml(f.title)}</div><div style="font-size:12px;color:var(--muted)">${escapeHtml(f.reference||"未填写文献")}</div></div></div>`).join("");
      box.classList.add("active");
    }

    function confirmImportDocx(){
      if(!pendingDocx.length){showToast("没有可导入的数据","error");return;}
      figures=figures.concat(pendingDocx.map(norm));saveData();renderAll();
      const n=pendingDocx.length;cancelDocxPreview();showToast("已导入 "+n+" 张结果图");showPage("gallery");
    }

    function cancelDocxPreview(){
      pendingDocx=[];document.getElementById("docxPreview").classList.remove("active");
      document.getElementById("docxList").innerHTML="";document.getElementById("docxFileInput").value="";
    }

    function openDetailModal(id){
      const f=figures.find(v=>v.id===id);if(!f)return;detailId=id;
      document.getElementById("detailImage").src=f.imageSrc||"";
      document.getElementById("detailType").textContent=f.type||"--";
      document.getElementById("detailTitle").textContent=f.title||"--";
      document.getElementById("detailReference").textContent=f.reference||"--";
      document.getElementById("detailYear").textContent=f.year||"--";
      document.getElementById("detailJournal").textContent=f.journal||"--";
      document.getElementById("detailKeywords").textContent=f.keywords||"--";
      document.getElementById("detailModal").classList.add("active");
    }

    function closeDetailModal(){detailId=null;document.getElementById("detailModal").classList.remove("active");}
    function downloadFigure(id){
      const f=figures.find(v=>v.id===id);if(!f||!f.imageSrc){showToast("该结果图没有可下载图片","error");return;}
      const a=document.createElement("a");a.href=f.imageSrc;a.download=safeName((f.title||"结果图")+".png");a.click();
    }
    function downloadCurrentFigure(){if(detailId)downloadFigure(detailId);}
    function deleteCurrentFigure(){
      if(!detailId)return;if(!confirm("确认删除这张结果图吗？"))return;
      figures=figures.filter(v=>v.id!==detailId);saveData();renderAll();closeDetailModal();showToast("已删除");
    }
    function copyDetailTitle(){
      const t=document.getElementById("detailTitle").textContent||"";
      navigator.clipboard.writeText(t).then(()=>showToast("图题已复制")).catch(()=>showToast("复制失败，请手动复制","error"));
    }

    function exportJsonData(){
      const blob=new Blob([JSON.stringify(figures,null,2)],{type:"application/json"});
      const url=URL.createObjectURL(blob),a=document.createElement("a");
      a.href=url;a.download="生态学结果图数据_"+new Date().toISOString().slice(0,10)+".json";a.click();URL.revokeObjectURL(url);
      showToast("JSON 导出成功");
    }

    function importJsonData(e){
      const file=e.target.files[0];if(!file)return;
      const r=new FileReader();
      r.onload=v=>{
        try{
          const p=JSON.parse(String(v.target.result||"[]")),arr=Array.isArray(p)?p:p.figures;
          if(!Array.isArray(arr))throw new Error("bad");
          figures=arr.map(norm).filter(Boolean);saveData();renderAll();showToast("JSON 导入成功");
        }catch(_){showToast("JSON 导入失败，请检查文件格式","error");}
        e.target.value="";
      };
      r.readAsText(file,"utf-8");
    }

    function clearAllData(){
      if(!confirm("确认清空全部数据？该操作不可恢复。"))return;
      figures=[];saveData();renderAll();cancelDocxPreview();pendingImage="";
      document.getElementById("imagePreview").innerHTML="";document.getElementById("imagePreview").classList.remove("active");
      showToast("数据已清空");
    }

    function gid(){return "fig_"+Date.now()+"_"+Math.random().toString(36).slice(2,8);}
    function showToast(msg,type){const t=document.getElementById("toast");t.textContent=msg;t.className="toast "+(type||"");setTimeout(()=>t.classList.add("show"),10);setTimeout(()=>t.classList.remove("show"),2300);}
    function safeName(s){return String(s||"figure.png").replace(/[\\/:*?\"<>|]/g,"_");}
    function escapeHtml(s){return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;").replace(/'/g,"&#39;");}
    function escapeJs(s){return String(s||"").replace(/\\/g,"\\\\").replace(/'/g,"\\'");}
  </script>
</body>
</html>
